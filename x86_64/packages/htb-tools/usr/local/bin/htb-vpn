#!/bin/sh

appkey=$(secret-tool lookup htb-api user-htb-api)

if [[ $# -ne 1 ]] ; then
    echo 'Please, provide one VPN server you prefer to connect: EUFree1,EUFree2,EUFree3,USFree1,USFree2,USFree3,AUFree1,SGFree1'
    exit 1
fi

vpn_server=$1

if [ $vpn_server == "EUFree1" ]; then
   vpn_id="1"
elif [ $vpn_server == "EUFree2" ]; then
   vpn_id="201"
elif [ $vpn_server == "EUFree3" ]; then
   vpn_id="253"
elif [ $vpn_server == "USFree1" ]; then
   vpn_id="113"
elif [ $vpn_server == "USFree2" ]; then
   vpn_id="202"
elif [ $vpn_server == "USFree3" ]; then
   vpn_id="254"
elif [ $vpn_server == "AUFree1" ]; then
   vpn_id="117"
elif [ $vpn_server == "SGFree1" ]; then
   vpn_id="251"
else
  echo "No VPN server! Closing..."
  exit 1
fi

sudo killall openvpn > /dev/null 2>&1
echo "Connecting to $1 server [id=$vpn_id]..."

#Care: if you run the same switch curl command, one time the VPN enables to the specified server, the second one disable

{ # try

    curl --silent --location --request POST "https://www.hackthebox.com/api/v4/connections/servers/switch/$vpn_id" -H "Authorization: Bearer $appkey" | jq '.message'
    curl --silent --location --request GET "https://www.hackthebox.com/api/v4/access/ovpnfile/$vpn_id/0" -H "Authorization: Bearer $appkey" -o $HOME/lab-vpn.ovpn

} || { # catch
    echo "Error. Maybe your API key is incorrect or expired. Renew your API key and rerun htb-update."
    exit 1
}

if grep -q "You are not assigned to this VPN Server" "$HOME/lab-vpn.ovpn"; then
  curl --silent --location --request POST "https://www.hackthebox.com/api/v4/connections/servers/switch/$vpn_id" -H "Authorization: Bearer $appkey" | jq '.message'
  curl --silent --location --request GET "https://www.hackthebox.com/api/v4/access/ovpnfile/$vpn_id/0" -H "Authorization: Bearer $appkey" -o $HOME/lab-vpn.ovpn
fi


echo "Asking sudo for openvpn..."

sudo openvpn $HOME/lab-vpn.ovpn &

sleep 5 #Needed for running commands (also from other scripts calling htb-vpn) after openvpn command

echo "You are running OpenVPN in background. For terminating it, close this window by mouse right-click on the window bar. If you type 'exit', OpenVPN will restart due to its native configuration."