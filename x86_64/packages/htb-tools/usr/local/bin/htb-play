#!/bin/sh

appkey=$(secret-tool lookup htb-api user-htb-api)

{ # try
    curl -s --location --request GET https://www.hackthebox.com/api/v4/machine/list/retired -H "Authorization: Bearer $appkey" | jq > $HOME/machine.json
} || { # catch
    echo -e "\e[31mError. Maybe your API key is incorrect or expired. Renew your API key by running htb-update.\e[0m"
    rm -rf $HOME/machine.json
    exit 1
}

count=$(jq -r '.info | length' $HOME/machine.json)
array_index_free_machines=()

echo "Loading retired machines..."

for sequence in $(seq $count)
do
  let index=$sequence-1
  free=$(jq -r ".info[$index].free" $HOME/machine.json)

  # Display variables
  if [ $free = "true" ]; then
    array_index_free_machines+=($index)
  fi

done

echo "Today, the free retired machines are: "
echo
for elem in "${array_index_free_machines[@]}"
do
    id=$(jq -r ".info[$elem].id" $HOME/machine.json)
    name=$(jq -r ".info[$elem].name" $HOME/machine.json)
    points=$(jq -r ".info[$elem].points" $HOME/machine.json)
    difficultyText=$(jq -r ".info[$elem].difficultyText" $HOME/machine.json)
    free=$(jq -r ".info[$elem].free" $HOME/machine.json)
    echo $name
done
echo
echo "What is the name of the machine you would like to play?"
read machine_name
echo

{ # try
    curl -s --location --request GET "https://www.hackthebox.com/api/v4/machine/profile/$machine_name" -H "Authorization: Bearer $appkey" | jq > $HOME/machine.json 
    if cat $HOME/machine.json | grep -q "Machine not found"; then
       echo "Machine not found"
       echo
       rm -rf $HOME/machine.json
       exit 1
    fi
    htb_user=$(curl -s --location --request GET "https://www.hackthebox.com/api/v4/user/info" -H "Authorization: Bearer $appkey" | jq '.info.name')
} || { # catch
    echo -e "\e[31mError. Maybe your API key is incorrect or expired. Renew your API key by running htb-update.\e[0m"
    rm -rf $HOME/machine.json
    exit 1
}

id=$(jq -r ".info.id" $HOME/machine.json)
name=$(jq -r ".info.name" $HOME/machine.json)
ip=$(jq -r ".info.ip" $HOME/machine.json)
points=$(jq -r ".info.points" $HOME/machine.json)
rm -rf $HOME/machine.json

htb-spawn $id $appkey $name $ip $points $htb_user
