#!/bin/sh

if [[ $# -ne 6 ]] ; then
    echo 'Please, provide the needed parameters: Machine ID, AppKey, Machine Name, IP Address, Points, HTB User'
    exit 1
fi

machine_id=$1
appkey=$2
machine_name=$3
machine_ip=$4
machine_points=$5
htb_user=$6
VPNArray=("EUFree1" "EUFree2" "EUFree3" "USFree1" "USFree2" "USFree3" "AUFree1" "SGFree1")

machine_json_file="$HOME/.machine.json"

if nmcli c show --active | grep -q tun ; then
  echo "VPN Server already running."
else  
  while [[ ! ${VPNArray[*]} =~ (^|[[:space:]])$vpn_server($|[[:space:]]) ]] #Use of ':space:' for Exact match in the array
  do
     echo "VPN Server not running. Type one of the following VPN servers:"
     echo -e "\e[36mEUFree1 EUFree2 EUFree3 USFree1 USFree2 USFree3 AUFree1 SGFree1\e[0m"
     echo -n "VPN Server:"
     read vpn_server
     htb-vpn $vpn_server
  done
fi

{ # try # Test if the API key is valid

    curl -s --location --request GET "https://www.hackthebox.com/api/v4/machine/profile/$machine_name" -H "Authorization: Bearer $appkey" | jq > $machine_json_file

} || { # catch
    echo "\e[31mError. Maybe your API key is incorrect or expired. Renew your API key by running htb-update.\e[0m"
    rm -rf $machine_json_file
    exit 1
}

machine_userflag=$(cat $machine_json_file | jq '.info.authUserInUserOwns')
machine_rootflag=$(cat $machine_json_file | jq '.info.authUserInRootOwns')

rm -rf $machine_json_file

if [ $machine_userflag != "null" ]; then
  echo "Hey! You have already found the User Flag! Nice one!"
fi

if [ $machine_rootflag != "null" ]; then
  echo "Hey! You have already found the Root Flag! Keep it up!"
fi

printf '%b\n' "$(base64 -d <<<"H4sIAAAAAAAAA+1buw6DMAzc+xVZWlUoSlCZqn5K+wv8/9oHUgkQIEBCDtueqlOHi+/imICVihunsL+9yqp6lo/7rb42P+t1iB1CcVjqWAzxkW3ZCtJEkH0QvU5GtGWkQ8wnyG5tu0h5g0Y/XhqME2jsEno7RHmyxVkbT9Bdbl9sV2g0rnsiymeDf9At/cZjBTSSCXfDbHx9wSghXSsQOQTnVW6jQCO/RUdaMkbLTYgP0EiLnagjU7Yk239wtbXl1FQMEd00Vp1GC41jXiT3CZRva2g5gJ2bKNbbomhysOtlTHbjE3oKWYcwb3ecM5Gf8dmXfnyk17gx9aih/JJgiBSeh1K+ygNUqZHbAtFENBFNRBPRRDQRTUSTuJoc8jLKl0VhFN8bZzR66RAs8Tp2UnQvz6zuGu4XZJ/BC0R/oSUpHeJ+ET/4GJbR9bxCEL4hccjuY7v7vA48bDe2DjG5t5yhO9hlLx5rjc/8kD1wBVncoox5ZHpMUhyUsYxNRMAILtp6otXA0RG4BcnZ4O3J+cuWwxtaDodVdT0AAA==" | gunzip)" #User printf for colored output
echo

if curl -s --location --request POST "https://www.hackthebox.com/api/v4/machine/play/$machine_id" -H "Authorization: Bearer $appkey" | jq '.message' | grep -q "Playing"; then

  result=$(basename -- "$SHELL")

  if [ $result = "bash" ]; then
    FILE="$HOME/.bashrc.htb.bak"
    if [ ! -f "$FILE" ]; then
       cp -rf $HOME/.bashrc $FILE
    fi
    sed -i "/PS1=/c\PS1=\"\\\\e[32m\\\\]â”Œâ”€â”€[Target:$machine_nameğŸŒIP:$machine_ipğŸš€âš”ï¸\\\\e[34m\\\\]Attacker:$htb_userğŸ“¡IP:\$(ip -f inet addr show tun0 | sed -En -e 's/.*inet ([0-9.]+).*/\\\1/p')\\\\e[32m\\\\]ğŸ†Prize:$machine_points points]\\\\nâ””â”€â”€â•¼[ğŸ‘¾]\\\\[\\\\e[36m\\\\]\\\$(pwd) $ \\\\[\\\\e[0m\\\\]\"" $HOME/.bashrc
    source $HOME/.bashrc
  elif [ $result = "fish" ]; then
    FILE="$HOME/.config/fish/functions/fish_prompt.fish.htb.bak"
    if [ ! -f "$FILE" ]; then
       mv $HOME/.config/fish/functions/fish_prompt.fish $FILE
    fi
cat <<EOF > $HOME/.config/fish/functions/fish_prompt.fish
  function fish_prompt
      set_color 00ff00
      echo -n "â”Œâ”€â”€[Target:$machine_nameğŸŒIP:$machine_ip"
      set_color ff00d7
      echo -n "âš”ï¸Attacker:$htb_userğŸ“¡IP:$(ip -f inet addr show tun0 | sed -En -e 's/.*inet ([0-9.]+).*/\1/p')"
      set_color 00ff00
      echo "ğŸ†Prize:$machine_points points]"
      set_color 00ff00
      echo -n "â””â”€â”€â•¼[ğŸ‘¾]"
      set_color 00ffff
      echo (pwd) '$' (set_color normal)
      end
EOF
  elif [ $result = "zsh" ]; then
      FILE="$HOME/.zshrc.htb.bak"
      if [ ! -f "$FILE" ]; then
         cp -rf $HOME/.zshrc $FILE
      fi
      sed -i "/PROMPT=/c\PROMPT=\"%F{46}â”Œâ”€â”€[Target:$machine_nameğŸŒIP:$machine_ipğŸš€âš”ï¸%F{201}Attacker:$htb_userğŸ“¡IP:\$(ip -f inet addr show tun0 | sed -En -e 's/.*inet ([0-9.]+).*/\\\1/p')ğŸ†%F{46}Prize:$machine_points points]\"$'\\\\n'\"â””â”€â”€â•¼[ğŸ‘¾]%F{44}%~ $%f \"" $HOME/.zshrc
      exec /usr/bin/zsh
  fi
    echo -e "\e[32mPlaying $machine_name. Good luck!\e[0m"
    echo
elif curl -s --location --request POST "https://www.hackthebox.com/api/v4/machine/play/$machine_id" -H "Authorization: Bearer $appkey" | jq '.message' | grep -q "Machine is VIP only"; then
    echo "Machine is VIP only."
    echo
elif curl -s --location --request POST "https://www.hackthebox.com/api/v4/machine/play/$machine_id" -H "Authorization: Bearer $appkey" | jq '.message' | grep -q "Machine is on Release Arena"; then
    echo "Machine is on Release Arena."
    echo
fi
