#!/bin/sh

if [[ $# -ne 6 ]] ; then
    echo 'Please, provide the needed parameters: Machine ID, AppKey, Machine Name, IP Address, Points, HTB User'
    exit 1
fi

machine_id=$1
appkey=$2
machine_name=$3
machine_ip=$4
machine_points=$5
htb_user=$6
VPNArray=("EUFree1" "EUFree2" "EUFree3" "USFree1" "USFree2" "USFree3" "AUFree1" "SGFree1")

if nmcli c show --active | grep -q tun ; then
  echo "VPN Server already running."
else  
  while [[ ! ${VPNArray[*]} =~ (^|[[:space:]])$vpn_server($|[[:space:]]) ]] #Use of ':space:' for Exact match in the array
  do
     echo "VPN Server not running. Type one of the following VPN servers:"
     echo -e "\e[36mEUFree1 EUFree2 EUFree3 USFree1 USFree2 USFree3 AUFree1 SGFree1\e[0m"
     echo -n "VPN Server:"
     read vpn_server
     htb-vpn $vpn_server
  done
fi

{ # try # Test if the API key is valid

    curl -s --location --request GET "https://www.hackthebox.com/api/v4/machine/profile/$machine_name" -H "Authorization: Bearer $appkey" | jq > $HOME/machine.json

} || { # catch
    echo "\e[31mError. Maybe your API key is incorrect or expired. Renew your API key by running htb-update.\e[0m"
    rm -rf $HOME/machine.json
    exit 1
}

machine_userflag=$(cat $HOME/machine.json | jq '.info.authUserInUserOwns')
machine_rootflag=$(cat $HOME/machine.json | jq '.info.authUserInRootOwns')

rm -rf $HOME/machine.json

if [ $machine_userflag != "null" ]; then
  echo "Hey! You have already found the User Flag! Nice one!"
fi

if [ $machine_rootflag != "null" ]; then
  echo "Hey! You have already found the Root Flag! Keep it up!"
fi

printf '%b\n' "$(base64 -d <<<"H4sIAAAAAAAAA+1buw6DMAzc+xVZWlUoSlCZqn5K+wv8/9oHUgkQIEBCDtueqlOHi+/imICVihunsL+9yqp6lo/7rb42P+t1iB1CcVjqWAzxkW3ZCtJEkH0QvU5GtGWkQ8wnyG5tu0h5g0Y/XhqME2jsEno7RHmyxVkbT9Bdbl9sV2g0rnsiymeDf9At/cZjBTSSCXfDbHx9wSghXSsQOQTnVW6jQCO/RUdaMkbLTYgP0EiLnagjU7Yk239wtbXl1FQMEd00Vp1GC41jXiT3CZRva2g5gJ2bKNbbomhysOtlTHbjE3oKWYcwb3ecM5Gf8dmXfnyk17gx9aih/JJgiBSeh1K+ygNUqZHbAtFENBFNRBPRRDQRTUSTuJoc8jLKl0VhFN8bZzR66RAs8Tp2UnQvz6zuGu4XZJ/BC0R/oSUpHeJ+ET/4GJbR9bxCEL4hccjuY7v7vA48bDe2DjG5t5yhO9hlLx5rjc/8kD1wBVncoox5ZHpMUhyUsYxNRMAILtp6otXA0RG4BcnZ4O3J+cuWwxtaDodVdT0AAA==" | gunzip)" #User printf for colored output
echo

if curl -s --location --request POST "https://www.hackthebox.com/api/v4/machine/play/$machine_id" -H "Authorization: Bearer $appkey" | jq '.message' | grep -q "Playing"; then

  sed -i "/PS1=/c\PS1='\\\\e[34m\\\\]‚îå‚îÄ‚îÄ[Target:$machine_nameüåêIP:$machine_ipüöÄ‚öîÔ∏èAttacker:$htb_userüì°IP:$(ip -f inet addr show tun0 | sed -En -e 's/.*inet ([0-9.]+).*/\1/p')\\\\e[32m\\\\]üèÜPrize:$machine_points points]\\\\n‚îî‚îÄ‚îÄ‚ïº[üëæ]\\\\[\\\\e[36m\\\\]\\\$(pwd) $ \\\\[\\\\e[0m\\\\]'" $HOME/.bashrc

  rm -rf $HOME/.config/fish/functions/fish_prompt.fish
cat <<EOF > $HOME/.config/fish/functions/fish_prompt.fish
  function fish_prompt
      set_color 00ff00
      echo -n "‚îå‚îÄ‚îÄ[Target:$machine_nameüåêIP:$machine_ip"
      set_color ff00d7
      echo -n "‚öîÔ∏èAttacker:$htb_userüì°IP:$(ip -f inet addr show tun0 | sed -En -e 's/.*inet ([0-9.]+).*/\1/p')"
      set_color 00ff00
      echo "]üèÜPrize:$machine_points points]"
      set_color 00ff00
      echo -n "‚îî‚îÄ‚îÄ‚ïº[üëæ]"
      set_color 00ffff
      echo (pwd) '$' (set_color normal)
      end
EOF
    echo -e "\e[32mPlaying $machine_name. Good luck!\e[0m"
    echo
elif curl -s --location --request POST "https://www.hackthebox.com/api/v4/machine/play/$machine_id" -H "Authorization: Bearer $appkey" | jq '.message' | grep -q "Machine is VIP only"; then
    echo "Machine is VIP only."
    echo
elif curl -s --location --request POST "https://www.hackthebox.com/api/v4/machine/play/$machine_id" -H "Authorization: Bearer $appkey" | jq '.message' | grep -q "Machine is on Release Arena"; then
    echo "Machine is on Release Arena."
    echo
fi
